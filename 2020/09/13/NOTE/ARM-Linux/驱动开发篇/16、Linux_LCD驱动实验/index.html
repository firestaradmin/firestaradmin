

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="firestaradmin">
  <meta name="keywords" content="">
  
    <meta name="description" content="Linux LCD驱动实验LCD 是很常用的一个外设，在裸机篇中我们讲解了如何编写 LCD 裸机驱动，在 Linux 下LCD 的使用更加广泛，在搭配 QT 这样的 GUI 库下可以制作出非常精美的 UI 界面。本章我们就来学习一下如何在 Linux 下驱动 LCD 屏幕。 一、Linux 下 LCD  驱动简析1| Framebuffer 设备先来回顾一下裸机的时候 LCD 驱动是怎么编写的，裸">
<meta property="og:type" content="article">
<meta property="og:title" content="16| Linux LCD驱动实验">
<meta property="og:url" content="http://firestaradmin.top/2020/09/13/NOTE/ARM-Linux/%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91%E7%AF%87/16%E3%80%81Linux_LCD%E9%A9%B1%E5%8A%A8%E5%AE%9E%E9%AA%8C/index.html">
<meta property="og:site_name" content="firestaradmin&#39;s Fortune">
<meta property="og:description" content="Linux LCD驱动实验LCD 是很常用的一个外设，在裸机篇中我们讲解了如何编写 LCD 裸机驱动，在 Linux 下LCD 的使用更加广泛，在搭配 QT 这样的 GUI 库下可以制作出非常精美的 UI 界面。本章我们就来学习一下如何在 Linux 下驱动 LCD 屏幕。 一、Linux 下 LCD  驱动简析1| Framebuffer 设备先来回顾一下裸机的时候 LCD 驱动是怎么编写的，裸">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://firestaradmin.top/2020/09/13/NOTE/ARM-Linux/%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91%E7%AF%87/16%E3%80%81Linux_LCD%E9%A9%B1%E5%8A%A8%E5%AE%9E%E9%AA%8C/image-20200829171727766.png">
<meta property="og:image" content="http://firestaradmin.top/2020/09/13/NOTE/ARM-Linux/%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91%E7%AF%87/16%E3%80%81Linux_LCD%E9%A9%B1%E5%8A%A8%E5%AE%9E%E9%AA%8C/image-20200829173052061.png">
<meta property="og:image" content="http://firestaradmin.top/2020/09/13/NOTE/ARM-Linux/%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91%E7%AF%87/16%E3%80%81Linux_LCD%E9%A9%B1%E5%8A%A8%E5%AE%9E%E9%AA%8C/image-20200829175456646.png">
<meta property="og:image" content="http://firestaradmin.top/2020/09/13/NOTE/ARM-Linux/%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91%E7%AF%87/16%E3%80%81Linux_LCD%E9%A9%B1%E5%8A%A8%E5%AE%9E%E9%AA%8C/image-20200829175529252.png">
<meta property="og:image" content="http://firestaradmin.top/2020/09/13/NOTE/ARM-Linux/%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91%E7%AF%87/16%E3%80%81Linux_LCD%E9%A9%B1%E5%8A%A8%E5%AE%9E%E9%AA%8C/image-20200829180715010.png">
<meta property="og:image" content="http://firestaradmin.top/2020/09/13/NOTE/ARM-Linux/%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91%E7%AF%87/16%E3%80%81Linux_LCD%E9%A9%B1%E5%8A%A8%E5%AE%9E%E9%AA%8C/image-20200829181040258.png">
<meta property="og:image" content="http://firestaradmin.top/2020/09/13/NOTE/ARM-Linux/%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91%E7%AF%87/16%E3%80%81Linux_LCD%E9%A9%B1%E5%8A%A8%E5%AE%9E%E9%AA%8C/image-20200829181118422.png">
<meta property="article:published_time" content="2020-09-12T16:00:00.000Z">
<meta property="article:modified_time" content="2020-09-12T16:00:00.000Z">
<meta property="article:author" content="firestaradmin">
<meta property="article:tag" content="Embedded">
<meta property="article:tag" content="ARM">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="驱动开发">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://firestaradmin.top/2020/09/13/NOTE/ARM-Linux/%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91%E7%AF%87/16%E3%80%81Linux_LCD%E9%A9%B1%E5%8A%A8%E5%AE%9E%E9%AA%8C/image-20200829171727766.png">
  
  
  <title>16| Linux LCD驱动实验 - firestaradmin&#39;s Fortune</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hint.css@2/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/hybrid.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />
  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"firestaradmin.top","root":"/","version":"1.8.14","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":1},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 6.0.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>firestaradmin&#39;s fortune</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                主页啦
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                文章
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于我
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/default_banner.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="16| Linux LCD驱动实验">
              
            </span>

            
              <div class="mt-3">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-author" aria-hidden="true"></i>
      firestaradmin
    </span>
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2020-09-13 00:00" pubdate>
        2020年9月13日 凌晨
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      19k 字
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      162 分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">16| Linux LCD驱动实验</h1>
            
            <div class="markdown-body">
              <h1 id="Linux-LCD驱动实验"><a href="#Linux-LCD驱动实验" class="headerlink" title="Linux LCD驱动实验"></a>Linux LCD驱动实验</h1><p>LCD 是很常用的一个外设，在裸机篇中我们讲解了如何编写 LCD 裸机驱动，在 Linux 下LCD 的使用更加广泛，在搭配 QT 这样的 GUI 库下可以制作出非常精美的 UI 界面。本章我们就来学习一下如何在 Linux 下驱动 LCD 屏幕。</p>
<h2 id="一、Linux-下-LCD-驱动简析"><a href="#一、Linux-下-LCD-驱动简析" class="headerlink" title="一、Linux 下 LCD  驱动简析"></a>一、Linux 下 LCD  驱动简析</h2><h3 id="1-Framebuffer-设备"><a href="#1-Framebuffer-设备" class="headerlink" title="1| Framebuffer 设备"></a>1| Framebuffer 设备</h3><p>先来回顾一下裸机的时候 LCD 驱动是怎么编写的，裸机 LCD 驱动编写流程如下：</p>
<p>①、初始化 I.MX6U 的 eLCDIF 控制器，重点是 LCD 屏幕宽(width)、高(height)、hspw、hbp、hfp、vspw、vbp 和 vfp 等信息。<br>②、初始化 LCD 像素时钟。<br>③、设置 RGBLCD 显存。<br>④、应用程序直接通过操作显存来操作 LCD，实现在 LCD 上显示字符、图片等信息。</p>
<p>在 Linux 中应用程序最终也是通过操作 RGB LCD 的显存来实现在 LCD 上显示字符、图片等信息。在裸机中我们可以随意的分配显存，但是在 Linux 系统中内存的管理很严格，显存是需要申请的，不是你想用就能用的。而且因为虚拟内存的存在，驱动程序设置的显存和应用程序访问的显存要是同一片物理内存。</p>
<p>为了解决上述问题，Framebuffer 诞生了， Framebuffer 翻译过来就是帧缓冲，简称 fb，因此大家在以后的 Linux 学习中见到“Framebuffer”或者“fb”的话第一反应应该想到 RGBLCD或者显示设备。</p>
<p>fb 是一种机制，将系统中所有跟显示有关的硬件以及软件集合起来，虚拟出一个 fb 设备，当我们编写好 LCD 驱动以后会生成一个名为&#x2F;dev&#x2F;fbX(X&#x3D;0~n)的设备，应用程序通过访问&#x2F;dev&#x2F;fbX 这个设备就可以访问 LCD。</p>
<p>NXP 官方的 Linux 内核默认已经开启了 LCD 驱动，因此我们是可以看到&#x2F;dev&#x2F;fb0 这样一个设备，如图所示：</p>
<p><img src="/2020/09/13/NOTE/ARM-Linux/%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91%E7%AF%87/16%E3%80%81Linux_LCD%E9%A9%B1%E5%8A%A8%E5%AE%9E%E9%AA%8C/image-20200829171727766.png" srcset="/img/loading.gif" lazyload alt="image-20200829171727766"></p>
<p>图中的&#x2F;dev&#x2F;fb0 就是 LCD 对应的设备文件，&#x2F;dev&#x2F;fb0 是个字符设备，因此肯定有file_operations 操作集，fb 的 file_operations 操作集定义在 drivers&#x2F;video&#x2F;fbdev&#x2F;core&#x2F;fbmem.c 文件中，如下所示：</p>
<div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-number">1495</span> <span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_operations</span> <span class="hljs-title">fb_fops</span> =</span> &#123;
<span class="hljs-number">1496</span> 	.owner = THIS_MODULE,
<span class="hljs-number">1497</span> 	.read = fb_read,
<span class="hljs-number">1498</span> 	.write = fb_write,
<span class="hljs-number">1499</span> 	.unlocked_ioctl = fb_ioctl,
<span class="hljs-number">1500</span> 	<span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_COMPAT</span>
<span class="hljs-number">1501</span> 		.compat_ioctl = fb_compat_ioctl,
<span class="hljs-number">1502</span> 	<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
<span class="hljs-number">1503</span> 	.mmap = fb_mmap,
<span class="hljs-number">1504</span> 	.open = fb_open,
<span class="hljs-number">1505</span> 	.release = fb_release,
<span class="hljs-number">1506</span> 	<span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> HAVE_ARCH_FB_UNMAPPED_AREA</span>
<span class="hljs-number">1507</span> 		.get_unmapped_area = get_fb_unmapped_area,
<span class="hljs-number">1508</span> 	<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
<span class="hljs-number">1509</span> 	<span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_FB_DEFERRED_IO</span>
<span class="hljs-number">1510</span> 		.fsync = fb_deferred_io_fsync,
<span class="hljs-number">1511</span> 	<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
<span class="hljs-number">1512</span> 	.llseek = default_llseek,
<span class="hljs-number">1513</span> &#125;;</code></pre></div>

<p>关于 fb 的详细处理过程就不去深究了，本章我们的重点是驱动起来 ALPHA 开发板上的LCD。</p>
<h3 id="2-LCD-驱动简析"><a href="#2-LCD-驱动简析" class="headerlink" title="2| LCD  驱动简析"></a>2| LCD  驱动简析</h3><p>LCD 裸机例程主要分两部分：<br>①、获取 LCD 的屏幕参数。<br>②、根据屏幕参数信息来初始化 eLCDIF 接口控制器。</p>
<p>不同分辨率的 LCD 屏幕其 eLCDIF 控制器驱动代码都是一样的，只需要修改好对应的屏幕参数即可。屏幕参数信息属于屏幕设备信息内容，这些肯定是要放到设备树中的，因此我们本章实验的主要工作就是修改设备树，NXP 官方的设备树已经添加了 LCD 设备节点，只是此节点的 LCD 屏幕信息是针对 NXP 官方 EVK 开发板所使用的 4.3 寸 480*272 编写的，我们需要将其改为我们所使用的屏幕参数。</p>
<p>我们简单看一下 NXP 官方编写的 Linux 下的 LCD 驱动，打开 imx6ull.dtsi，然后找到 lcdif节点内容，如下所示：</p>
<div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-number">1</span> lcdif: lcdif@<span class="hljs-number">021</span>c8000 &#123;
<span class="hljs-number">2</span> 	compatible = <span class="hljs-string">&quot;fsl,imx6ul-lcdif&quot;</span>, <span class="hljs-string">&quot;fsl,imx28-lcdif&quot;</span>;
<span class="hljs-number">3</span> 	reg = &lt;<span class="hljs-number">0x021c8000</span> <span class="hljs-number">0x4000</span>&gt;;
<span class="hljs-number">4</span> 	interrupts = &lt;GIC_SPI <span class="hljs-number">5</span> IRQ_TYPE_LEVEL_HIGH&gt;;
<span class="hljs-number">5</span> 	clocks = &lt;&amp;clks IMX6UL_CLK_LCDIF_PIX&gt;,
<span class="hljs-number">6</span> 			 &lt;&amp;clks IMX6UL_CLK_LCDIF_APB&gt;,
<span class="hljs-number">7</span> 			 &lt;&amp;clks IMX6UL_CLK_DUMMY&gt;;
<span class="hljs-number">8</span> 	clock-names = <span class="hljs-string">&quot;pix&quot;</span>, <span class="hljs-string">&quot;axi&quot;</span>, <span class="hljs-string">&quot;disp_axi&quot;</span>;
<span class="hljs-number">9</span> 	status = <span class="hljs-string">&quot;disabled&quot;</span>;
<span class="hljs-number">10</span> &#125;;</code></pre></div>

<p>示例代码中的 lcdif 节点信息是所有使用 I.MX6ULL 芯片的板子所共有的，并不是完整的 lcdif 节点信息。</p>
<p>像屏幕参数这些需要根据不同的硬件平台去添加，比如向 imx6ull-lxg-emmc.dts 中的 lcdif 节点添加其他的属性信息。从示例代码可以看出 lcdif 节点的 compatible 属性值为“fsl,imx6ul-lcdif”和“fsl,imx28-lcdi”，因此在 Linux 源码中搜索这两个字符串即可找到 I.MX6ULL 的 LCD 驱动文件，这个文件为 drivers&#x2F;video&#x2F;fbdev&#x2F;mxsfb.c，mxsfb.c就是 I.MX6ULL 的 LCD 驱动文件，在此文件中找到如下内容：</p>
<div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-number">1362</span> <span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">of_device_id</span> <span class="hljs-title">mxsfb_dt_ids</span>[] =</span> &#123;
<span class="hljs-number">1363</span> 	&#123; .compatible = <span class="hljs-string">&quot;fsl,imx23-lcdif&quot;</span>, .data = &amp;mxsfb_devtype[<span class="hljs-number">0</span>], &#125;,
<span class="hljs-number">1364</span> 	&#123; .compatible = <span class="hljs-string">&quot;fsl,imx28-lcdif&quot;</span>, .data = &amp;mxsfb_devtype[<span class="hljs-number">1</span>], &#125;,
<span class="hljs-number">1365</span> 	&#123; <span class="hljs-comment">/* sentinel */</span> &#125;
<span class="hljs-number">1366</span> &#125;;
......
<span class="hljs-number">1625</span> <span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">platform_driver</span> <span class="hljs-title">mxsfb_driver</span> =</span> &#123;
<span class="hljs-number">1626</span> 	.probe = mxsfb_probe,
<span class="hljs-number">1627</span> 	.remove = mxsfb_remove,
<span class="hljs-number">1628</span> 	.shutdown = mxsfb_shutdown,
<span class="hljs-number">1629</span> 	.id_table = mxsfb_devtype,
<span class="hljs-number">1630</span> 	.driver = &#123;
<span class="hljs-number">1631</span> 		.name = DRIVER_NAME,
<span class="hljs-number">1632</span> 		.of_match_table = mxsfb_dt_ids,
<span class="hljs-number">1633</span> 		.pm = &amp;mxsfb_pm_ops,
<span class="hljs-number">1634</span> 	&#125;,
<span class="hljs-number">1635</span> &#125;;
<span class="hljs-number">1636</span>
<span class="hljs-number">1637</span> module_platform_driver(mxsfb_driver);</code></pre></div>

<p>从示例代码 可以看出，这是一个标准的 platform 驱动，当驱动和设备匹配以后mxsfb_probe 函数就会执行。在看 mxsfb_probe 函数之前我们先简单了解一下 Linux 下Framebuffer 驱动的编写流程，Linux 内核将所有的 Framebuffer 抽象为一个叫做 fb_info 的结构体，fb_info 结构体包含了 Framebuffer 设备的完整属性和操作集合，因此每一个 Framebuffer 设备都必须有一个 fb_info。换言之就是，LCD 的驱动就是构建 fb_info，并且向系统注册 fb_info的过程。fb_info 结构体定义在 include&#x2F;linux&#x2F;fb.h 文件里面，内容如下(省略掉条件编译)：</p>
<div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-number">448</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fb_info</span> &#123;</span>
<span class="hljs-number">449</span> 	<span class="hljs-type">atomic_t</span> count;
<span class="hljs-number">450</span> 	<span class="hljs-type">int</span> node;
<span class="hljs-number">451</span> 	<span class="hljs-type">int</span> flags;
<span class="hljs-number">452</span> 	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mutex</span> <span class="hljs-title">lock</span>;</span> 		<span class="hljs-comment">/* 互斥锁 */</span>
<span class="hljs-number">453</span> 	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mutex</span> <span class="hljs-title">mm_lock</span>;</span> 	<span class="hljs-comment">/* 互斥锁，用于 fb_mmap 和 smem_*域*/</span>
<span class="hljs-number">454</span> 	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fb_var_screeninfo</span> <span class="hljs-title">var</span>;</span> 	<span class="hljs-comment">/* 当前可变参数 */</span>
<span class="hljs-number">455</span> 	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fb_fix_screeninfo</span> <span class="hljs-title">fix</span>;</span> 	<span class="hljs-comment">/* 当前固定参数 */</span>
<span class="hljs-number">456</span> 	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fb_monspecs</span> <span class="hljs-title">monspecs</span>;</span>  	<span class="hljs-comment">/* 当前显示器特性 */</span>
<span class="hljs-number">457</span> 	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">work_struct</span> <span class="hljs-title">queue</span>;</span> 		<span class="hljs-comment">/* 帧缓冲事件队列 */</span>
<span class="hljs-number">458</span> 	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fb_pixmap</span> <span class="hljs-title">pixmap</span>;</span> 		<span class="hljs-comment">/* 图像硬件映射 */</span>
<span class="hljs-number">459</span> 	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fb_pixmap</span> <span class="hljs-title">sprite</span>;</span> 		<span class="hljs-comment">/* 光标硬件映射 */</span>
<span class="hljs-number">460</span> 	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fb_cmap</span> <span class="hljs-title">cmap</span>;</span> 			<span class="hljs-comment">/* 当前调色板 */</span>
<span class="hljs-number">461</span> 	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">modelist</span>;</span> 		<span class="hljs-comment">/* 当前模式列表 */</span>
<span class="hljs-number">462</span> 	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fb_videomode</span> *<span class="hljs-title">mode</span>;</span> 		<span class="hljs-comment">/* 当前视频模式 */</span>
<span class="hljs-number">463</span>
<span class="hljs-number">464</span> <span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_FB_BACKLIGHT <span class="hljs-comment">/* 如果 LCD 支持背光的话 */</span></span>
<span class="hljs-number">465</span> 	<span class="hljs-comment">/* assigned backlight device */</span>
<span class="hljs-number">466</span> 	<span class="hljs-comment">/* set before framebuffer registration,</span>
<span class="hljs-comment">467 	   remove after unregister */</span>
<span class="hljs-number">468</span> 	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">backlight_device</span> *<span class="hljs-title">bl_dev</span>;</span>  <span class="hljs-comment">/* 背光设备 */</span>
<span class="hljs-number">469</span>
<span class="hljs-number">470</span> 	<span class="hljs-comment">/* Backlight level curve */</span>
<span class="hljs-number">471</span> 	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mutex</span> <span class="hljs-title">bl_curve_mutex</span>;</span>
<span class="hljs-number">472</span> 	u8 bl_curve[FB_BACKLIGHT_LEVELS];
<span class="hljs-number">473</span> <span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
......
<span class="hljs-number">479</span> 	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fb_ops</span> *<span class="hljs-title">fbops</span>;</span> <span class="hljs-comment">/* 帧缓冲操作函数集 */</span>
<span class="hljs-number">480</span> 	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">device</span> *<span class="hljs-title">device</span>;</span> <span class="hljs-comment">/* 父设备 */</span>
<span class="hljs-number">481</span> 	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">device</span> *<span class="hljs-title">dev</span>;</span> <span class="hljs-comment">/* 当前 fb 设备 */</span>
<span class="hljs-number">482</span> 	<span class="hljs-type">int</span> class_flag; <span class="hljs-comment">/* 私有 sysfs 标志 */</span>
......
<span class="hljs-number">486</span> 	<span class="hljs-type">char</span> __iomem *screen_base; <span class="hljs-comment">/* 虚拟内存基地址(屏幕显存) */</span>
<span class="hljs-number">487</span> 	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> screen_size; <span class="hljs-comment">/* 虚拟内存大小(屏幕显存大小) */</span>
<span class="hljs-number">488</span> 	<span class="hljs-type">void</span> *pseudo_palette; <span class="hljs-comment">/* 伪 16 位调色板 */</span>
......
<span class="hljs-number">507</span> &#125;;</code></pre></div>

<p>fb_info 结构体的成员变量很多，我们重点关注 var、fix、fbops、screen_base、screen_size和 pseudo_palette。</p>
<p>mxsfb_probe 函数的主要工作内容为：</p>
<p>①、申请 fb_info。<br>②、初始化 fb_info 结构体中的各个成员变量。<br>③、初始化 eLCDIF 控制器。<br>④、使用 register_framebuffer 函数向 Linux 内核注册初始化好的 fb_info。</p>
<p>register_framebuffer函数原型如下：</p>
<ul>
<li><div class="hljs code-wrapper"><pre><code class="hljs">int register_framebuffer(struct fb_info *fb_info)
<pre><code class="hljs yaml">
  <span class="hljs-string">函数参数和返回值含义如下：</span>
  <span class="hljs-string">**fb_info**：需要上报的</span> <span class="hljs-string">fb_info。</span>
  <span class="hljs-string">**返回值**：0，成功；负值，失败。</span>

<span class="hljs-meta">---</span>
<span class="hljs-meta"></span>
<span class="hljs-string">接下来我们简单看一下</span> <span class="hljs-string">mxsfb_probe</span> <span class="hljs-string">函数，函数内容如下(有缩减)：</span>

<span class="hljs-string">```c</span>
<span class="hljs-number">1369 </span><span class="hljs-string">static</span> <span class="hljs-string">int</span> <span class="hljs-string">mxsfb_probe(struct</span> <span class="hljs-string">platform_device</span> <span class="hljs-string">*pdev)</span>
<span class="hljs-number">1370</span> &#123;
<span class="hljs-number">1371 	</span><span class="hljs-string">const</span> <span class="hljs-string">struct</span> <span class="hljs-string">of_device_id</span> <span class="hljs-string">*of_id</span> <span class="hljs-string">=</span>
<span class="hljs-number">1372 			</span><span class="hljs-string">of_match_device(mxsfb_dt_ids</span>, <span class="hljs-string">&amp;pdev-&gt;dev);</span>
<span class="hljs-number">1373 	</span><span class="hljs-string">struct</span> <span class="hljs-string">resource</span> <span class="hljs-string">*res;</span>
<span class="hljs-number">1374 	</span><span class="hljs-string">struct</span> <span class="hljs-string">mxsfb_info</span> <span class="hljs-string">*host;</span>
<span class="hljs-number">1375 	</span><span class="hljs-string">struct</span> <span class="hljs-string">fb_info</span> <span class="hljs-string">*fb_info;</span>
<span class="hljs-number">1376 	</span><span class="hljs-string">struct</span> <span class="hljs-string">pinctrl</span> <span class="hljs-string">*pinctrl;</span>
<span class="hljs-number">1377 	</span><span class="hljs-string">int</span> <span class="hljs-string">irq</span> <span class="hljs-string">=</span> <span class="hljs-string">platform_get_irq(pdev</span>, <span class="hljs-number">0</span><span class="hljs-string">);</span>
<span class="hljs-number">1378 	</span><span class="hljs-string">int</span> <span class="hljs-string">gpio</span>, <span class="hljs-string">ret;</span>
<span class="hljs-number">1379</span>
<span class="hljs-string">......</span>
<span class="hljs-number">1394</span>
<span class="hljs-number">1395 	</span><span class="hljs-string">res</span> <span class="hljs-string">=</span> <span class="hljs-string">platform_get_resource(pdev</span>, <span class="hljs-string">IORESOURCE_MEM</span>, <span class="hljs-number">0</span><span class="hljs-string">);</span>
<span class="hljs-number">1396 	</span><span class="hljs-string">if</span> <span class="hljs-string">(!res)</span> &#123;
<span class="hljs-number">1397 		</span><span class="hljs-string">dev_err(&amp;pdev-&gt;dev</span>, <span class="hljs-string">&quot;Cannot get memory IO resource\n&quot;</span><span class="hljs-string">);</span>
<span class="hljs-number">1398 		</span><span class="hljs-string">return</span> <span class="hljs-string">-ENODEV;</span>
<span class="hljs-number">1399</span> 	&#125;
<span class="hljs-number">1400</span>
<span class="hljs-number">1401 	</span><span class="hljs-string">host</span> <span class="hljs-string">=</span> <span class="hljs-string">devm_kzalloc(&amp;pdev-&gt;dev</span>, <span class="hljs-string">sizeof(struct</span> <span class="hljs-string">mxsfb_info)</span>, <span class="hljs-string">GFP_KERNEL);</span>
<span class="hljs-number">1402 	</span><span class="hljs-string">if</span> <span class="hljs-string">(!host)</span> &#123;
<span class="hljs-number">1403 		</span><span class="hljs-string">dev_err(&amp;pdev-&gt;dev</span>, <span class="hljs-string">&quot;Failed to allocate IO resource\n&quot;</span><span class="hljs-string">);</span>
<span class="hljs-number">1404 		</span><span class="hljs-string">return</span> <span class="hljs-string">-ENOMEM;</span>
<span class="hljs-number">1405</span> 	&#125;
<span class="hljs-number">1406</span>
<span class="hljs-number">1407 	</span><span class="hljs-string">fb_info</span> <span class="hljs-string">=</span> <span class="hljs-string">framebuffer_alloc(sizeof(struct</span> <span class="hljs-string">fb_info)</span>, <span class="hljs-string">&amp;pdev-&gt;dev);</span>
<span class="hljs-number">1408 	</span><span class="hljs-string">if</span> <span class="hljs-string">(!fb_info)</span> &#123;
<span class="hljs-number">1409 		</span><span class="hljs-string">dev_err(&amp;pdev-&gt;dev</span>, <span class="hljs-string">&quot;Failed to allocate fbdev\n&quot;</span><span class="hljs-string">);</span>
<span class="hljs-number">1410 		</span><span class="hljs-string">devm_kfree(&amp;pdev-&gt;dev</span>, <span class="hljs-string">host);</span>
<span class="hljs-number">1411 		</span><span class="hljs-string">return</span> <span class="hljs-string">-ENOMEM;</span>
<span class="hljs-number">1412</span> 	&#125;
<span class="hljs-number">1413 	</span><span class="hljs-string">host-&gt;fb_info</span> <span class="hljs-string">=</span> <span class="hljs-string">fb_info;</span>
<span class="hljs-number">1414 	</span><span class="hljs-string">fb_info-&gt;par</span> <span class="hljs-string">=</span> <span class="hljs-string">host;</span>
<span class="hljs-number">1415</span>
<span class="hljs-number">1416 	</span><span class="hljs-string">ret</span> <span class="hljs-string">=</span> <span class="hljs-string">devm_request_irq(&amp;pdev-&gt;dev</span>, <span class="hljs-string">irq</span>, <span class="hljs-string">mxsfb_irq_handler</span>, <span class="hljs-number">0</span>,
<span class="hljs-number">1417 	</span><span class="hljs-string">dev_name(&amp;pdev-&gt;dev)</span>, <span class="hljs-string">host);</span>
<span class="hljs-number">1418 	</span><span class="hljs-string">if</span> <span class="hljs-string">(ret)</span> &#123;
<span class="hljs-number">1419 		</span><span class="hljs-string">dev_err(&amp;pdev-&gt;dev</span>, <span class="hljs-string">&quot;request_irq (%d) failed with</span>
<span class="hljs-string">1420 		error %d\n&quot;</span>, <span class="hljs-string">irq</span>, <span class="hljs-string">ret);</span>
<span class="hljs-number">1421 		</span><span class="hljs-string">ret</span> <span class="hljs-string">=</span> <span class="hljs-string">-ENODEV;</span>
<span class="hljs-number">1422 		</span><span class="hljs-string">goto</span> <span class="hljs-string">fb_release;</span>
<span class="hljs-number">1423</span> 	&#125;
<span class="hljs-number">1424</span>
<span class="hljs-number">1425 	</span><span class="hljs-string">host-&gt;base</span> <span class="hljs-string">=</span> <span class="hljs-string">devm_ioremap_resource(&amp;pdev-&gt;dev</span>, <span class="hljs-string">res);</span>
<span class="hljs-number">1426 	</span><span class="hljs-string">if</span> <span class="hljs-string">(IS_ERR(host-&gt;base))</span> &#123;
<span class="hljs-number">1427 		</span><span class="hljs-string">dev_err(&amp;pdev-&gt;dev</span>, <span class="hljs-string">&quot;ioremap failed\n&quot;</span><span class="hljs-string">);</span>
<span class="hljs-number">1428 		</span><span class="hljs-string">ret</span> <span class="hljs-string">=</span> <span class="hljs-string">PTR_ERR(host-&gt;base);</span>
<span class="hljs-number">1429 		</span><span class="hljs-string">goto</span> <span class="hljs-string">fb_release;</span>
<span class="hljs-number">1430</span> 	&#125;
<span class="hljs-string">......</span>
<span class="hljs-number">1461</span>
<span class="hljs-number">1462 	</span><span class="hljs-string">fb_info-&gt;pseudo_palette</span> <span class="hljs-string">=</span> <span class="hljs-string">devm_kzalloc(&amp;pdev-&gt;dev</span>, <span class="hljs-string">sizeof(u32)</span> <span class="hljs-string">*</span>
<span class="hljs-number">1463 														</span><span class="hljs-number">16</span>, <span class="hljs-string">GFP_KERNEL);</span>
<span class="hljs-number">1464 	</span><span class="hljs-string">if</span> <span class="hljs-string">(!fb_info-&gt;pseudo_palette)</span> &#123;
<span class="hljs-number">1465 		</span><span class="hljs-string">ret</span> <span class="hljs-string">=</span> <span class="hljs-string">-ENOMEM;</span>
<span class="hljs-number">1466 		</span><span class="hljs-string">goto</span> <span class="hljs-string">fb_release;</span>
<span class="hljs-number">1467</span> 	&#125;
<span class="hljs-number">1468</span>
<span class="hljs-number">1469 	</span><span class="hljs-string">INIT_LIST_HEAD(&amp;fb_info-&gt;modelist);</span>
<span class="hljs-number">1470</span>
<span class="hljs-number">1473 	</span><span class="hljs-string">ret</span> <span class="hljs-string">=</span> <span class="hljs-string">mxsfb_init_fbinfo(host);</span>
<span class="hljs-number">1474 	</span><span class="hljs-string">if</span> <span class="hljs-string">(ret</span> <span class="hljs-type">!=</span> <span class="hljs-number">0</span><span class="hljs-string">)</span>
<span class="hljs-number">1475 		</span><span class="hljs-string">goto</span> <span class="hljs-string">fb_pm_runtime_disable;</span>
<span class="hljs-number">1476</span>
<span class="hljs-number">1477 	</span><span class="hljs-string">mxsfb_dispdrv_init(pdev</span>, <span class="hljs-string">fb_info);</span>
<span class="hljs-number">1478</span>
<span class="hljs-number">1479 	</span><span class="hljs-string">if</span> <span class="hljs-string">(!host-&gt;dispdrv)</span> &#123;
<span class="hljs-number">1480 		</span><span class="hljs-string">pinctrl</span> <span class="hljs-string">=</span> <span class="hljs-string">devm_pinctrl_get_select_default(&amp;pdev-&gt;dev);</span>
<span class="hljs-number">1481 		</span><span class="hljs-string">if</span> <span class="hljs-string">(IS_ERR(pinctrl))</span> &#123;
<span class="hljs-number">1482 			</span><span class="hljs-string">ret</span> <span class="hljs-string">=</span> <span class="hljs-string">PTR_ERR(pinctrl);</span>
<span class="hljs-number">1483 			</span><span class="hljs-string">goto</span> <span class="hljs-string">fb_pm_runtime_disable;</span>
<span class="hljs-number">1484</span> 		&#125;
<span class="hljs-number">1485</span> 	&#125;
<span class="hljs-number">1486</span>
<span class="hljs-number">1487 	</span><span class="hljs-string">if</span> <span class="hljs-string">(!host-&gt;enabled)</span> &#123;
<span class="hljs-number">1488 		</span><span class="hljs-string">writel(0</span>, <span class="hljs-string">host-&gt;base</span> <span class="hljs-string">+</span> <span class="hljs-string">LCDC_CTRL);</span>
<span class="hljs-number">1489 		</span><span class="hljs-string">mxsfb_set_par(fb_info);</span>
<span class="hljs-number">1490 		</span><span class="hljs-string">mxsfb_enable_controller(fb_info);</span>
<span class="hljs-number">1491 		</span><span class="hljs-string">pm_runtime_get_sync(&amp;host-&gt;pdev-&gt;dev);</span>
<span class="hljs-number">1492</span> 	&#125;
<span class="hljs-number">1493</span>
<span class="hljs-number">1494 	</span><span class="hljs-string">ret</span> <span class="hljs-string">=</span> <span class="hljs-string">register_framebuffer(fb_info);</span>
<span class="hljs-number">1495 	</span><span class="hljs-string">if</span> <span class="hljs-string">(ret</span> <span class="hljs-type">!=</span> <span class="hljs-number">0</span><span class="hljs-string">)</span> &#123;
<span class="hljs-number">1496 		</span><span class="hljs-string">dev_err(&amp;pdev-&gt;dev</span>, <span class="hljs-string">&quot;Failed to register framebuffer\n&quot;</span><span class="hljs-string">);</span>
<span class="hljs-number">1497 		</span><span class="hljs-string">goto</span> <span class="hljs-string">fb_destroy;</span>
<span class="hljs-number">1498</span> 	&#125;
<span class="hljs-string">......</span>
<span class="hljs-number">1525 	</span><span class="hljs-string">return</span> <span class="hljs-string">ret;</span>
<span class="hljs-number">1526</span> &#125;</code></pre></div>
</code></pre>
</li>
<li><p><strong>第 1374 行</strong>，host 结构体指针变量，表示 I.MX6ULL 的 LCD 的主控接口，mxsfb_info 结构体是 NXP 定义的针对 I.MX 系列 SOC 的 Framebuffer 设备结构体。也就是我们前面一直说的设备结构体，此结构体包含了 I.MX 系列 SOC 的 Framebuffer 设备详细信息，比如时钟、eLCDIF控制器寄存器基地址、fb_info 等。</p>
</li>
<li><p><strong>第 1395 行</strong>，从设备树中获取 eLCDIF 接口控制器的寄存器首地址，设备树中 lcdif 节点已经设置了 eLCDIF 寄存器首地址为 0X021C8000，因此 res&#x3D;0X021C8000。</p>
</li>
<li><p><strong>第 1401 行</strong>，给 host 申请内存，host 为 mxsfb_info 类型结构体指针。</p>
</li>
<li><p><strong>第 1407 行</strong>，给 fb_info 申请内存，也就是申请 fb_info。</p>
</li>
<li><p><strong>第 1413~1414 行</strong>，设置 host 的 fb_info 成员变量为 fb_info，设置 fb_info 的 par 成员变量为host。通过这一步就将前面申请的 host 和 fb_info 联系在了一起。</p>
</li>
<li><p><strong>第 1416 行</strong>，申请中断，中断服务函数为 mxsfb_irq_handler。</p>
</li>
<li><p><strong>第 1425 行</strong>，对从设备树中获取到的寄存器首地址(res)进行内存映射，得到虚拟地址，并保存到host 的 base 成员变量。因此通过访问 host 的 base 成员即可访问 I.MX6ULL 的整个 eLCDIF寄存器。其实在 mxsfb.c 中已经定义了 eLCDIF 各个寄存器相比于基地址的偏移值，如下所示：</p>
<div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-number">67</span> <span class="hljs-meta">#<span class="hljs-keyword">define</span> LCDC_CTRL 0x00</span>
<span class="hljs-number">68</span> <span class="hljs-meta">#<span class="hljs-keyword">define</span> LCDC_CTRL1 0x10</span>
<span class="hljs-number">69</span> <span class="hljs-meta">#<span class="hljs-keyword">define</span> LCDC_V4_CTRL2 0x20</span>
<span class="hljs-number">70</span> <span class="hljs-meta">#<span class="hljs-keyword">define</span> LCDC_V3_TRANSFER_COUNT 0x20</span>
<span class="hljs-number">71</span> <span class="hljs-meta">#<span class="hljs-keyword">define</span> LCDC_V4_TRANSFER_COUNT 0x30</span>
......
<span class="hljs-number">89</span> <span class="hljs-meta">#<span class="hljs-keyword">define</span> LCDC_V4_DEBUG0 0x1d0</span>
<span class="hljs-number">90</span> <span class="hljs-meta">#<span class="hljs-keyword">define</span> LCDC_V3_DEBUG0 0x1f0</span></code></pre></div>

<p>大家可以对比着《I.MX6ULL 参考手册》中的 eLCDIF 章节检查一下上述示例代码中的这些寄存器有没有错误。</p>
</li>
<li><p><strong>第1462行</strong>，给fb_info中的pseudo_palette申请内存。</p>
</li>
<li><p><strong>第 1473 行</strong>，调用 mxsfb_init_fbinfo 函数初始化 fb_info，重点是 fb_info 的 var、fix、fbops，screen_base 和 screen_size。其中 fbops 是 Framebuffer 设备的操作集，NXP 提供的 fbops 为mxsfb_ops，内容如下：</p>
<div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-number">987</span> <span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fb_ops</span> <span class="hljs-title">mxsfb_ops</span> =</span> &#123;
<span class="hljs-number">988</span> 	.owner = THIS_MODULE,
<span class="hljs-number">989</span> 	.fb_check_var = mxsfb_check_var,
<span class="hljs-number">990</span> 	.fb_set_par = mxsfb_set_par,
<span class="hljs-number">991</span> 	.fb_setcolreg = mxsfb_setcolreg,
<span class="hljs-number">992</span> 	.fb_ioctl = mxsfb_ioctl,
<span class="hljs-number">993</span> 	.fb_blank = mxsfb_blank,
<span class="hljs-number">994</span> 	.fb_pan_display = mxsfb_pan_display,
<span class="hljs-number">995</span> 	.fb_mmap = mxsfb_mmap,
<span class="hljs-number">996</span> 	.fb_fillrect = cfb_fillrect,
<span class="hljs-number">997</span> 	.fb_copyarea = cfb_copyarea,
<span class="hljs-number">998</span> 	.fb_imageblit = cfb_imageblit,
<span class="hljs-number">999</span> &#125;;</code></pre></div>

<p>关于 mxsfb_ops 里面的各个操作函数这里就不去详解的介绍了。mxsfb_init_fbinfo 函数通过调用 mxsfb_init_fbinfo_dt 函数从设备树中获取到 LCD 的各个参数信息。最后，mxsfb_init_fbinfo函数会调用 mxsfb_map_videomem 函数申请 LCD 的帧缓冲内存(也就是显存)。</p>
</li>
<li><p><strong>第 1489~1490 行</strong>，设置 eLCDIF 控制器的相应寄存器。</p>
</li>
<li><p><strong>第 1494 行</strong>，最后调用 register_framebuffer 函数向 Linux 内核注册 fb_info。<br>mxsfb.c 文件很大，还有一些其他的重要函数，比如 mxsfb_remove、mxsfb_shutdown 等，<br>这里我们就简单的介绍了一下 mxsfb_probe 函数，至于其他的函数大家自行查阅。</p>
</li>
</ul>
<h2 id="二、硬件原理图分析"><a href="#二、硬件原理图分析" class="headerlink" title="二、硬件原理图分析"></a>二、硬件原理图分析</h2><p><img src="/2020/09/13/NOTE/ARM-Linux/%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91%E7%AF%87/16%E3%80%81Linux_LCD%E9%A9%B1%E5%8A%A8%E5%AE%9E%E9%AA%8C/image-20200829173052061.png" srcset="/img/loading.gif" lazyload alt="image-20200829173052061"></p>
<h2 id="三、-LCD-驱动程序编写"><a href="#三、-LCD-驱动程序编写" class="headerlink" title="三、 LCD  驱动程序编写"></a>三、 LCD  驱动程序编写</h2><p>前面已经说了，6ULL 的 eLCDIF 接口驱动程序 NXP 已经编写好了，因此 LCD 驱动部分我们不需要去修改。我们需要做的就是按照所使用的 LCD 来修改设备树。重点要注意三个地方：<br>①、LCD 所使用的 IO 配置。<br>②、LCD 屏幕节点修改，修改相应的属性值，换成我们所使用的 LCD 屏幕参数。<br>③、LCD 背光节点信息修改，要根据实际所使用的背光 IO 来修改相应的设备节点信息。</p>
<p>接下来我们依次来看一下上面这两个节点改如何去修改：</p>
<h3 id="1-LCD-屏幕-IO-配置"><a href="#1-LCD-屏幕-IO-配置" class="headerlink" title="1| LCD  屏幕 IO  配置"></a>1| LCD  屏幕 IO  配置</h3><p>首先要检查一下设备树中 LCD 所使用的 IO 配置，这个其实 NXP 都已经给我们写好了，不需要修改，不过我们还是要看一下。打开 imx6ull-lxg-emmc.dts 文件，在 iomuxc 节点中找到如下内容：</p>
<div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-number">1</span> pinctrl_lcdif_dat: lcdifdatgrp &#123;
<span class="hljs-number">2</span> 	fsl,pins = &lt;
<span class="hljs-number">3</span> 		MX6UL_PAD_LCD_DATA00__LCDIF_DATA00 <span class="hljs-number">0x79</span>
<span class="hljs-number">4</span> 		MX6UL_PAD_LCD_DATA01__LCDIF_DATA01 <span class="hljs-number">0x79</span>
<span class="hljs-number">5</span> 		MX6UL_PAD_LCD_DATA02__LCDIF_DATA02 <span class="hljs-number">0x79</span>
<span class="hljs-number">6</span> 		MX6UL_PAD_LCD_DATA03__LCDIF_DATA03 <span class="hljs-number">0x79</span>
<span class="hljs-number">7</span> 		MX6UL_PAD_LCD_DATA04__LCDIF_DATA04 <span class="hljs-number">0x79</span>
<span class="hljs-number">8</span> 		MX6UL_PAD_LCD_DATA05__LCDIF_DATA05 <span class="hljs-number">0x79</span>
<span class="hljs-number">9</span> 		MX6UL_PAD_LCD_DATA06__LCDIF_DATA06 <span class="hljs-number">0x79</span>
<span class="hljs-number">10</span> 		MX6UL_PAD_LCD_DATA07__LCDIF_DATA07 <span class="hljs-number">0x79</span>
<span class="hljs-number">11</span> 		MX6UL_PAD_LCD_DATA08__LCDIF_DATA08 <span class="hljs-number">0x79</span>
<span class="hljs-number">12</span> 		MX6UL_PAD_LCD_DATA09__LCDIF_DATA09 <span class="hljs-number">0x79</span>
<span class="hljs-number">13</span> 		MX6UL_PAD_LCD_DATA10__LCDIF_DATA10 <span class="hljs-number">0x79</span>
<span class="hljs-number">14</span> 		MX6UL_PAD_LCD_DATA11__LCDIF_DATA11 <span class="hljs-number">0x79</span>
<span class="hljs-number">15</span> 		MX6UL_PAD_LCD_DATA12__LCDIF_DATA12 <span class="hljs-number">0x79</span>
<span class="hljs-number">16</span> 		MX6UL_PAD_LCD_DATA13__LCDIF_DATA13 <span class="hljs-number">0x79</span>
<span class="hljs-number">17</span> 		MX6UL_PAD_LCD_DATA14__LCDIF_DATA14 <span class="hljs-number">0x79</span>
<span class="hljs-number">18</span> 		MX6UL_PAD_LCD_DATA15__LCDIF_DATA15 <span class="hljs-number">0x79</span>
<span class="hljs-number">19</span> 		MX6UL_PAD_LCD_DATA16__LCDIF_DATA16 <span class="hljs-number">0x79</span>
<span class="hljs-number">20</span> 		MX6UL_PAD_LCD_DATA17__LCDIF_DATA17 <span class="hljs-number">0x79</span>
<span class="hljs-number">21</span> 		MX6UL_PAD_LCD_DATA18__LCDIF_DATA18 <span class="hljs-number">0x79</span>
<span class="hljs-number">22</span> 		MX6UL_PAD_LCD_DATA19__LCDIF_DATA19 <span class="hljs-number">0x79</span>
<span class="hljs-number">23</span> 		MX6UL_PAD_LCD_DATA20__LCDIF_DATA20 <span class="hljs-number">0x79</span>
<span class="hljs-number">24</span> 		MX6UL_PAD_LCD_DATA21__LCDIF_DATA21 <span class="hljs-number">0x79</span>
<span class="hljs-number">25</span> 		MX6UL_PAD_LCD_DATA22__LCDIF_DATA22 <span class="hljs-number">0x79</span>
<span class="hljs-number">26</span> 		MX6UL_PAD_LCD_DATA23__LCDIF_DATA23 <span class="hljs-number">0x79</span>
<span class="hljs-number">27</span> 	&gt;;
<span class="hljs-number">28</span> &#125;;
<span class="hljs-number">29</span>
<span class="hljs-number">30</span> pinctrl_lcdif_ctrl: lcdifctrlgrp &#123;
<span class="hljs-number">31</span> 	fsl,pins = &lt;
<span class="hljs-number">32</span> 		MX6UL_PAD_LCD_CLK__LCDIF_CLK <span class="hljs-number">0x79</span>
<span class="hljs-number">33</span> 		MX6UL_PAD_LCD_ENABLE__LCDIF_ENABLE <span class="hljs-number">0x79</span>
<span class="hljs-number">34</span> 		MX6UL_PAD_LCD_HSYNC__LCDIF_HSYNC <span class="hljs-number">0x79</span>
<span class="hljs-number">35</span> 		MX6UL_PAD_LCD_VSYNC__LCDIF_VSYNC <span class="hljs-number">0x79</span>
<span class="hljs-number">36</span> 	&gt;;
<span class="hljs-number">37</span> 	pinctrl_pwm1: pwm1grp &#123;
<span class="hljs-number">38</span> 	fsl,pins = &lt;
<span class="hljs-number">39</span> 		MX6UL_PAD_GPIO1_IO08__PWM1_OUT <span class="hljs-number">0x110b0</span>
<span class="hljs-number">40</span> 	&gt;;
<span class="hljs-number">41</span> &#125;;</code></pre></div>

<p>第 2~27 行，子节点 pinctrl_lcdif_dat，为 RGB LCD 的 24 根数据线配置项。</p>
<p>第 30~36 行，子节点 pinctrl_lcdif_ctrl，RGB LCD 的 4 根控制线配置项，包括 CLK、ENABLE、VSYNC 和 HSYNC。</p>
<p>第 37~40 行，子节点 pinctrl_pwm1，LCD 背光 PWM 引脚配置项。这个引脚要根据实际情况设置，这里我们建议大家在以后的学习或工作中，LCD 的背光 IO 尽量和半导体厂商的官方开发板一致。</p>
<h3 id="2-LCD-屏幕参数节点信息修改"><a href="#2-LCD-屏幕参数节点信息修改" class="headerlink" title="2| LCD  屏幕参数节点信息修改"></a>2| LCD  屏幕参数节点信息修改</h3><p>继续在 imx6ull-lxg-emmc.dts 文件中找到 lcdif 节点，节点内容如下所示：</p>
<div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-number">1</span> &amp;lcdif &#123;
<span class="hljs-number">2</span> 		pinctrl-names = <span class="hljs-string">&quot;default&quot;</span>;
<span class="hljs-number">3</span> 		pinctrl<span class="hljs-number">-0</span> = &lt;&amp;pinctrl_lcdif_dat <span class="hljs-comment">/* 使用到的 IO */</span>
<span class="hljs-number">4</span> 		&amp;pinctrl_lcdif_ctrl
<span class="hljs-number">5</span> 		&amp;pinctrl_lcdif_reset&gt;;
<span class="hljs-number">6</span> 		display = &lt;&amp;display0&gt;;
<span class="hljs-number">7</span> 		status = <span class="hljs-string">&quot;okay&quot;</span>;
<span class="hljs-number">8</span>
<span class="hljs-number">9</span> 		display0: display &#123;		 	<span class="hljs-comment">/* LCD 属性信息 */</span>
<span class="hljs-number">10</span> 			bits-per-pixel = &lt;<span class="hljs-number">16</span>&gt;; 	<span class="hljs-comment">/* 一个像素占用几个 bit */</span>
<span class="hljs-number">11</span> 			bus-width = &lt;<span class="hljs-number">24</span>&gt;;	 	<span class="hljs-comment">/* 总线宽度 */</span>
<span class="hljs-number">12</span>
<span class="hljs-number">13</span> 			display-timings &#123;
<span class="hljs-number">14</span> 				native-mode = &lt;&amp;timing0&gt;; <span class="hljs-comment">/* 时序信息 */</span>
<span class="hljs-number">15</span> 				timing0: timing0 &#123;
<span class="hljs-number">16</span> 				clock-frequency = &lt;<span class="hljs-number">9200000</span>&gt;; <span class="hljs-comment">/* LCD 像素时钟，单位 Hz */</span>
<span class="hljs-number">17</span> 				hactive = &lt;<span class="hljs-number">480</span>&gt;; 			<span class="hljs-comment">/* LCD X 轴像素个数 */</span>
<span class="hljs-number">18</span> 				vactive = &lt;<span class="hljs-number">272</span>&gt;; 			<span class="hljs-comment">/* LCD Y 轴像素个数 */</span>
<span class="hljs-number">19</span> 				hfront-porch = &lt;<span class="hljs-number">8</span>&gt;; 		<span class="hljs-comment">/* LCD hfp 参数 */</span>
<span class="hljs-number">20</span> 				hback-porch = &lt;<span class="hljs-number">4</span>&gt;; 			<span class="hljs-comment">/* LCD hbp 参数 */</span>
<span class="hljs-number">21</span> 				hsync-len = &lt;<span class="hljs-number">41</span>&gt;; 			<span class="hljs-comment">/* LCD hspw 参数 */</span>
<span class="hljs-number">22</span> 				vback-porch = &lt;<span class="hljs-number">2</span>&gt;; 			<span class="hljs-comment">/* LCD vbp 参数 */</span>
<span class="hljs-number">23</span> 				vfront-porch = &lt;<span class="hljs-number">4</span>&gt;; 		<span class="hljs-comment">/* LCD vfp 参数 */</span>
<span class="hljs-number">24</span> 				vsync-len = &lt;<span class="hljs-number">10</span>&gt;; 			<span class="hljs-comment">/* LCD vspw 参数 */</span>
<span class="hljs-number">25</span>
<span class="hljs-number">26</span> 				hsync-active = &lt;<span class="hljs-number">0</span>&gt;; 		<span class="hljs-comment">/* hsync 数据线极性 */</span>
<span class="hljs-number">27</span> 				vsync-active = &lt;<span class="hljs-number">0</span>&gt;; 		<span class="hljs-comment">/* vsync 数据线极性 */</span>
<span class="hljs-number">28</span> 				de-active = &lt;<span class="hljs-number">1</span>&gt;; 			<span class="hljs-comment">/* de 数据线极性 */</span>
<span class="hljs-number">29</span> 				pixelclk-active = &lt;<span class="hljs-number">0</span>&gt;; 		<span class="hljs-comment">/* clk 数据线先极性 */</span>
<span class="hljs-number">30</span> 				&#125;;
<span class="hljs-number">31</span> 			&#125;;
<span class="hljs-number">32</span> 		&#125;;
<span class="hljs-number">33</span> &#125;;</code></pre></div>

<p>上述示例代码 就是向 imx6ull.dtsi 文件中的 lcdif 节点追加的内容，我们依次来看一下示例代码 中的这些属性都是写什么含义。</p>
<p><strong>第 3 行</strong>，pinctrl-0 属性，LCD 所使用的 IO 信息，这里用到了 <strong>pinctrl_lcdif_dat、pinctrl_lcdif_ctrl和 pinctrl_lcdif_reset</strong> 这三个 IO 相关的节点，pinctrl_lcdif_reset 是 LCD 复位 IO 信息节点，正点原子的 I.MX6U-ALPHA 开发板的 LCD 没有用到复位 IO，因此pinctrl_lcdif_reset 可以删除掉。</p>
<p><strong>第 6 行</strong>，display 属性，指定 LCD 属性信息所在的子节点，这里为 display0，下面就是display0子节点内容。</p>
<p><strong>第 9~32 行</strong>，display0 子节点，描述 LCD 的参数信息，第 10 行的 bits-per-pixel 属性用于指明一个像素占用的 bit 数，默认为 16bit。本教程我们将 LCD 配置为 RGB888 模式，因此一个像素点占用 24bit，bits-per-pixel 属性要改为 24。第 11 行的 bus-width 属性用于设置数据线宽度，因为要配置为 RGB888 模式，因此 bus-width 也要设置为 24。</p>
<p><strong>第 13~30 行</strong>，这几行非常重要！因为这几行设置了 LCD 的时序参数信息，NXP 官方的 EVK开发板使用了一个 4.3 寸的 480*272 屏幕，因此这里默认是按照 NXP 官方的那个屏幕参数设置的。每一个属性的含义后面的注释已经写的很详细了，大家自己去看就行了，这些时序参数就是我们重点要修改的，需要根据自己所使用的屏幕去修改。</p>
<p>这里以正点原子的 ATK7016(7 寸 1024*600)屏幕为例，将 imx6ull-lxg-emmc.dts 文件中的 lcdif 节点改为如下内容：</p>
<div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-number">1</span> &amp;lcdif &#123;
<span class="hljs-number">2</span> 		pinctrl-names = <span class="hljs-string">&quot;default&quot;</span>;
<span class="hljs-number">3</span> 		pinctrl<span class="hljs-number">-0</span> = &lt;&amp;pinctrl_lcdif_dat <span class="hljs-comment">/*  使用到的 IO */</span>
<span class="hljs-number">4</span> 		&amp;pinctrl_lcdif_ctrl&gt;;
<span class="hljs-number">5</span> 		display = &lt;&amp;display0&gt;;
<span class="hljs-number">6</span> 		status = <span class="hljs-string">&quot;okay&quot;</span>;
<span class="hljs-number">7</span>
<span class="hljs-number">8</span> 		display0: display &#123; 		<span class="hljs-comment">/* LCD 属性信息 */</span>
<span class="hljs-number">9</span> 			bits-per-pixel = &lt;<span class="hljs-number">24</span>&gt;; 	<span class="hljs-comment">/*  一个像素占用 24bit  */</span>
<span class="hljs-number">10</span> 			bus-width = &lt;<span class="hljs-number">24</span>&gt;; 		<span class="hljs-comment">/* 总线宽度 */</span>
<span class="hljs-number">11</span>
<span class="hljs-number">12</span> 			display-timings &#123;
<span class="hljs-number">13</span> 				native-mode = &lt;&amp;timing0&gt;; <span class="hljs-comment">/* 时序信息 */</span>
<span class="hljs-number">14</span> 				timing0: timing0 &#123;
<span class="hljs-number">15</span> 					clock-frequency = &lt;<span class="hljs-number">51200000</span>&gt;; <span class="hljs-comment">/* LCD  像素时钟，单位 Hz */</span>
<span class="hljs-number">16</span> 					hactive = &lt;<span class="hljs-number">1024</span>&gt;; 		<span class="hljs-comment">/* LCD X  轴像素个数 */</span>
<span class="hljs-number">17</span> 					vactive = &lt;<span class="hljs-number">600</span>&gt;; 		<span class="hljs-comment">/* LCD Y  轴像素个数 */</span>
<span class="hljs-number">18</span> 					hfront-porch = &lt;<span class="hljs-number">160</span>&gt;; 	<span class="hljs-comment">/* LCD hfp  参数 */</span>
<span class="hljs-number">19</span> 					hback-porch = &lt;<span class="hljs-number">140</span>&gt;; 	<span class="hljs-comment">/* LCD hbp  参数 */</span>
<span class="hljs-number">20</span> 					hsync-len = &lt;<span class="hljs-number">20</span>&gt;; 		<span class="hljs-comment">/* LCD hspw  参数 */</span>
<span class="hljs-number">21</span> 					vback-porch = &lt;<span class="hljs-number">20</span>&gt;; 	<span class="hljs-comment">/* LCD vbp  参数 */</span>
<span class="hljs-number">22</span> 					vfront-porch = &lt;<span class="hljs-number">12</span>&gt;; 	<span class="hljs-comment">/* LCD vfp  参数 */</span>
<span class="hljs-number">23</span> 					vsync-len = &lt;<span class="hljs-number">3</span>&gt;; 		<span class="hljs-comment">/* LCD vspw  参数 */</span>
<span class="hljs-number">24</span>
<span class="hljs-number">25</span> 					hsync-active = &lt;<span class="hljs-number">0</span>&gt;; 	<span class="hljs-comment">/* hsync 数据线极性 */</span>
<span class="hljs-number">26</span> 					vsync-active = &lt;<span class="hljs-number">0</span>&gt;; 	<span class="hljs-comment">/* vsync 数据线极性 */</span>
<span class="hljs-number">27</span> 					de-active = &lt;<span class="hljs-number">1</span>&gt;; 		<span class="hljs-comment">/* de 数据线极性 */</span>
<span class="hljs-number">28</span> 					pixelclk-active = &lt;<span class="hljs-number">0</span>&gt;; 	<span class="hljs-comment">/* clk 数据线先极性 */</span>
<span class="hljs-number">29</span> 				&#125;;
<span class="hljs-number">30</span> 			&#125;;
<span class="hljs-number">31</span> 		&#125;;
<span class="hljs-number">32</span> &#125;;</code></pre></div>

<p>第 3 行，设置 LCD 屏幕所使用的 IO，删除掉原来的 pinctrl_lcdif_reset，因为没有用到屏幕复位 IO，其他的 IO 不变。</p>
<p>第 9 行，使用 RGB888 模式，所以一个像素点是 24bit。</p>
<p>第 15~23 行，ATK7016 屏幕时序参数，根据自己所使用的屏幕修改即可。</p>
<h3 id="3-LCD-屏幕背光节点信息"><a href="#3-LCD-屏幕背光节点信息" class="headerlink" title="3| LCD  屏幕背光节点信息"></a>3| LCD  屏幕背光节点信息</h3><p>正点原子的 LCD 接口背光控制 IO 连接到了 I.MX6U 的 GPIO1_IO08 引脚上，GPIO1_IO08复用为 PWM1_OUT，通过 PWM 信号来控制 LCD 屏幕背光的亮度。正点原子 I.MX6U-ALPHA 开发板的 LCD 背光引脚和 NXP 官方 EVK 开发板的背光引脚一样，因此背光的设备树节点是不需要修改的，但是考虑到其他同学可能使用别的开发板或者屏幕，LCD 背光引脚和 NXP 官方 EVK 开发板可能不同，因此我们还是来看一下如何在设备树中添加背光节点信息。</p>
<p>先是 GPIO1_IO08 这个 IO 的配置，在 imx6ull-lxg-emmc.dts 中找到如下内容：</p>
<div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-number">1</span> pinctrl_pwm1: pwm1grp &#123;
<span class="hljs-number">2</span> 	fsl,pins = &lt;
<span class="hljs-number">3</span> 		MX6UL_PAD_GPIO1_IO08__PWM1_OUT <span class="hljs-number">0x110b0</span>
<span class="hljs-number">4</span> 	&gt;;
<span class="hljs-number">5</span> &#125;;</code></pre></div>

<p>pinctrl_pwm1 节点就是 GPIO1_IO08 的配置节点，从第 3 行可以看出，设置 GPIO1_IO08这个 IO 复用为 PWM1_OUT，并且设置电气属性值为 0x110b0。LCD 背光要用到 PWM1，因此也要设置 PWM1 节点，在 imx6ull.dtsi 文件中找到如下内容：</p>
<div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-number">1</span> pwm1: pwm@<span class="hljs-number">02080000</span> &#123;
<span class="hljs-number">2</span> 	compatible = <span class="hljs-string">&quot;fsl,imx6ul-pwm&quot;</span>, <span class="hljs-string">&quot;fsl,imx27-pwm&quot;</span>;
<span class="hljs-number">3</span> 	reg = &lt;<span class="hljs-number">0x02080000</span> <span class="hljs-number">0x4000</span>&gt;;
<span class="hljs-number">4</span> 	interrupts = &lt;GIC_SPI <span class="hljs-number">83</span> IRQ_TYPE_LEVEL_HIGH&gt;;
<span class="hljs-number">5</span> 	clocks = &lt;&amp;clks IMX6UL_CLK_PWM1&gt;,
<span class="hljs-number">6</span> 			 &lt;&amp;clks IMX6UL_CLK_PWM1&gt;;
<span class="hljs-number">7</span> 	clock-names = <span class="hljs-string">&quot;ipg&quot;</span>, <span class="hljs-string">&quot;per&quot;</span>;
<span class="hljs-number">8</span> 	<span class="hljs-meta">#pwm-cells = <span class="hljs-string">&lt;2&gt;</span>;</span>
<span class="hljs-number">9</span> &#125;;</code></pre></div>

<p>imx6ull.dtsi 文件中的 pwm1 节点信息大家不要修改，如果要修改 pwm1 节点内容的话请在imx6ull-lxg-emmc.dts 文件中修改。</p>
<p>在整个 Linux 源码文件中搜索 compatible 属性的这两个值即可找到 imx6ull 的 pwm 驱动文件，imx6ull 的 PWM 驱动文件为 drivers&#x2F;pwm&#x2F;pwm-imx.c，这里我们就不详细的去分析这个文件了。</p>
<p>继续在 imx6ull-lxg-emmc.dts 文件中找到向 pwm1追加的内容，如下所示：</p>
<div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-number">1</span> &amp;pwm1 &#123;
<span class="hljs-number">2</span> 	pinctrl-names = <span class="hljs-string">&quot;default&quot;</span>;
<span class="hljs-number">3</span> 	pinctrl<span class="hljs-number">-0</span> = &lt;&amp;pinctrl_pwm1&gt;;
<span class="hljs-number">4</span> 	status = <span class="hljs-string">&quot;okay&quot;</span>;
<span class="hljs-number">5</span> &#125;;</code></pre></div>

<p>第 3 行，设置 pwm1 所使用的 IO 为 pinctrl_pwm1，也就是示例代码所定义的GPIO1_IO08 这个 IO。<br>第 4 行，将 status 设置为 okay。</p>
<p>如果背光用的其他 pwm 通道，比如 pwm2，那么就需要仿照示例代码的内容，向pwm2 节点追加相应的内容。</p>
<p>pwm 和相关的 IO 已经准备好了，但是 Linux 系统怎么知道PWM1_OUT就是控制LCD背光的呢？因此我们还需要一个节点来将LCD背光和PWM1_OUT连接起来。这个节点就是 backlight，<strong>backlight节点描述</strong>可以参考<strong>Documentation&#x2F;devicetree&#x2F;indings&#x2F;video&#x2F;backlight&#x2F;pwm-backlight.txt</strong> 这个文档，此文档详细讲解了backlight 节点该如何去创建，这里大概总结一下：</p>
<ul>
<li>①、<strong>节点名称</strong>要为“backlight”。</li>
<li>②、节点的 <strong>compatible 属性</strong>值要为“pwm-backlight”，因此可以通过在 Linux 内核中搜索“ pwm-backlight ” 来查找PWM背光控制驱动程序，这个驱动程序文件为drivers&#x2F;video&#x2F;backlight&#x2F;pwm_bl.c，感兴趣的可以去看一下这个驱动程序。</li>
<li>③、<strong>pwms属性</strong>用于描述背光所使用的PWM以及PWM频率，比如本章我们要使用的pwm1，pwm 频率设置为 5KHz(NXP 官方推荐设置)。</li>
<li>④、<strong>brightness-levels 属性描述亮度级别</strong>，范围为 0~255，0 表示 PWM 占空比为 0%，也就是亮度最低，255 表示 100%占空比，也就是亮度最高。至于设置几级亮度，大家可以自行填写此属性。</li>
<li>⑤、default-brightness-level 属性为默认亮度级别。</li>
</ul>
<p>根据上述 5 点设置 backlight 节点，这个 NXP 已经给我们设置好了，大家在 imx6ull-lxg-emmc.dts 文件中找到如下内容：</p>
<div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-number">1</span> backlight &#123;
<span class="hljs-number">2</span> 	compatible = <span class="hljs-string">&quot;pwm-backlight&quot;</span>;
<span class="hljs-number">3</span> 	pwms = &lt;&amp;pwm1 <span class="hljs-number">0</span> <span class="hljs-number">5000000</span>&gt;;
<span class="hljs-number">4</span> 	brightness-levels = &lt;<span class="hljs-number">0</span> <span class="hljs-number">4</span> <span class="hljs-number">8</span> <span class="hljs-number">16</span> <span class="hljs-number">32</span> <span class="hljs-number">64</span> <span class="hljs-number">128</span> <span class="hljs-number">255</span>&gt;;
<span class="hljs-number">5</span> 	<span class="hljs-keyword">default</span>-brightness-level = &lt;<span class="hljs-number">6</span>&gt;;
<span class="hljs-number">6</span> 	status = <span class="hljs-string">&quot;okay&quot;</span>;
<span class="hljs-number">7</span> &#125;;</code></pre></div>

<ul>
<li>第 3 行，设置背光使用 pwm1，PWM 频率为 5KHz。</li>
<li>第 4 行，设置背 8 级背光(0~7)，分别为 0、4、8、16、32、64、128、255，对应占空比为0%、1.57%、3.13%、6.27%、12.55%、25.1%、50.19%、100%，如果嫌少的话可以自行添加一些其他的背光等级值。</li>
<li>第 5 行，设置默认背光等级为 6，也就是 50.19%的亮度。关于背光的设备树节点信息就讲到这里，整个的 LCD 设备树节点内容我们就讲完了，按照这些节点内容配置自己的开发板即可。</li>
</ul>
<h2 id="四、运行测试"><a href="#四、运行测试" class="headerlink" title="四、运行测试"></a>四、运行测试</h2><h3 id="1-LCD屏幕基本测试"><a href="#1-LCD屏幕基本测试" class="headerlink" title="1| LCD屏幕基本测试"></a>1| LCD屏幕基本测试</h3><h4 id="1-编译新的设备树"><a href="#1-编译新的设备树" class="headerlink" title="1.编译新的设备树"></a>1.编译新的设备树</h4><p>上一小节我们已经配置好了设备树，所以需要输入如下命令重新编译一下设备树：<br><code>make dtbs</code><br>等待编译生成新的 imx6ull-alientek-emmc.dtb 设备树文件，一会要使用新的设备树启动Linux 内核</p>
<h4 id="2-使能-Linux-logo-显示"><a href="#2-使能-Linux-logo-显示" class="headerlink" title="2.使能 Linux logo  显示"></a>2.使能 Linux logo  显示</h4><p>Linux 内核启动的时候可以选择显示小企鹅 logo，只要这个小企鹅 logo 显示没问题那么我们的 LCD 驱动基本就工作正常了。这个 logo 显示是要配置的，不过 Linux 内核一般都会默认开启 logo 显示，但是奔着学习的目的，我们还是来看一下如何使能 Linux logo 显示。打开 Linux内核图形化配置界面，按下路径找到对应的配置项：</p>
<div class="hljs code-wrapper"><pre><code class="hljs elm">-&gt; <span class="hljs-type">Device</span> <span class="hljs-type">Drivers</span>
    -&gt; <span class="hljs-type">Graphics</span> sup<span class="hljs-keyword">port</span>
        -&gt; <span class="hljs-type">Bootup</span> logo (<span class="hljs-type">LOGO</span> [=y])
            -&gt; <span class="hljs-type">Standard</span> black and white <span class="hljs-type">Linux</span> logo
            -&gt; <span class="hljs-type">Standard</span> <span class="hljs-number">16</span>-color <span class="hljs-type">Linux</span> logo
            -&gt; <span class="hljs-type">Standard</span> <span class="hljs-number">224</span>-color <span class="hljs-type">Linux</span> logo</code></pre></div>

<p>如图 所示：</p>
<p><img src="/2020/09/13/NOTE/ARM-Linux/%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91%E7%AF%87/16%E3%80%81Linux_LCD%E9%A9%B1%E5%8A%A8%E5%AE%9E%E9%AA%8C/image-20200829175456646.png" srcset="/img/loading.gif" lazyload alt="image-20200829175456646"></p>
<p>图 中这三个选项分别对应黑白、16 位、24 位色彩格式的 logo，我们把这三个都选中，都编译进 Linux 内核里面。设置好以后保存退出，重新编译 Linux 内核，编译完成以后使用新编译出来的 imx6ull-lxg-emmc.dtb 和 zImage 镜像启动系统，如果 LCD 驱动工作正常的话就会在 LCD 屏幕左上角出现一个彩色的小企鹅 logo，屏幕背景色为黑色，如图 所示：</p>
<p><img src="/2020/09/13/NOTE/ARM-Linux/%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91%E7%AF%87/16%E3%80%81Linux_LCD%E9%A9%B1%E5%8A%A8%E5%AE%9E%E9%AA%8C/image-20200829175529252.png" srcset="/img/loading.gif" lazyload alt="image-20200829175529252"></p>
<h3 id="2-设置-LCD-作为终端控制台"><a href="#2-设置-LCD-作为终端控制台" class="headerlink" title="2| 设置 LCD  作为终端控制台"></a>2| 设置 LCD  作为终端控制台</h3><p>我们一直使用SecureCRT作为Linux开发板终端，开发板通过串口和SecureCRT进行通信。现在我们已经驱动起来 LCD 了，所以可以设置 LCD 作为终端，也就是开发板使用自己的显示设备作为自己的终端，然后接上键盘就可以直接在开发板上敲命令了(前提是USB驱动设置好)，将 LCD 设置为终端控制台的方法如下：</p>
<h4 id="1-、设置-uboot-中的-bootargs"><a href="#1-、设置-uboot-中的-bootargs" class="headerlink" title="1 、设置 uboot  中的 bootargs"></a>1 、设置 uboot  中的 bootargs</h4><p>重启开发板，进入 Linux 命令行，重新设置 bootargs 参数的 console 内容，命令如下所示：</p>
<div class="hljs code-wrapper"><pre><code class="hljs apache"><span class="hljs-attribute">setenv</span> bootargs &#x27;console=tty1 console=ttymxc0,<span class="hljs-number">115200</span> root=/dev/nfs nfsroot=<span class="hljs-number">192.168.0.200</span>:/home/firestaradmin/linux/nfs/rootfs,proto=tcp rw ip=<span class="hljs-number">192.168.0.210:192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">0</span>.<span class="hljs-number">200</span>:<span class="hljs-number">192.168.0.1:255</span>.<span class="hljs-number">255</span>.<span class="hljs-number">255</span>.<span class="hljs-number">0</span>::eth0:<span class="hljs-literal">off</span>&#x27;</code></pre></div>

<p>注意分设置 console，这里我们设置了两遍 console，第一次设置 console&#x3D;tty1，也就是设置 LCD 屏幕为控制台，第二遍又设置 console&#x3D;ttymxc0,115200，也就是设置串口也作为控制台。相当于我们打开了两个 console，一个是 LCD，一个是串口，大家重启开发板就会发现 LCD 和串口都会显示 Linux 启动 log 信息。但是此时我们还不能使用 LCD 作为终端进行交互，因为我们的设置还未完成。</p>
<h4 id="2、修改-x2F-etc-x2F-inittab-文件"><a href="#2、修改-x2F-etc-x2F-inittab-文件" class="headerlink" title="2、修改&#x2F;etc&#x2F;inittab  文件"></a>2、修改&#x2F;etc&#x2F;inittab  文件</h4><p>打开开发板根文件系统中的&#x2F;etc&#x2F;inittab 文件，在里面加入下面这一行：</p>
<div class="hljs code-wrapper"><pre><code class="hljs arcade">tty1::askfirst:-<span class="hljs-regexp">/bin/</span>sh</code></pre></div>

<p>添加完成以后的&#x2F;etc&#x2F;inittab 文件内容如图  所示：</p>
<p><img src="/2020/09/13/NOTE/ARM-Linux/%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91%E7%AF%87/16%E3%80%81Linux_LCD%E9%A9%B1%E5%8A%A8%E5%AE%9E%E9%AA%8C/image-20200829180715010.png" srcset="/img/loading.gif" lazyload alt="image-20200829180715010"></p>
<p>修改完成以后保存&#x2F;etc&#x2F;inittab 并退出，然后重启开发板，重启以后开发板 LCD 屏幕最后一行会显示下面一行语句：</p>
<div class="hljs code-wrapper"><pre><code class="hljs applescript">Please press Enter <span class="hljs-keyword">to</span> <span class="hljs-built_in">activate</span> this console.</code></pre></div>

<p>上述提示语句说的是：按下回车键使能当前终端，我们之前已经将 I.MX6U-ALPHA 开发板上的 KEY 按键注册为了回车键，因此按下开发板上的 KEY 按键即可使能 LCD这个终端。当然了，大家也可以接上一个 USB 键盘，Linux 内核默认已经使能了 USB 键盘驱动了，因此可以直接使用 USB 键盘。</p>
<p>至此，我们就拥有了两套终端，一个是基于串口的 SecureCRT，一个就是我们开发板的 LCD屏幕，但是为了方便调试，我们以后还是以 SecureCRT 为主。</p>
<p>我们可以通过下面这一行命令向LCD 屏幕输出“hello linux！”</p>
<div class="hljs code-wrapper"><pre><code class="hljs sh"><span class="hljs-built_in">echo</span> hello linux &gt; /dev/tty1</code></pre></div>

<h3 id="3-LCD-背光调节"><a href="#3-LCD-背光调节" class="headerlink" title="3| LCD  背光调节"></a>3| LCD  背光调节</h3><p>背光设备树节点设置了 8 个等级的背光调节，可以设置为 0~7，我们可以通过设置背光等级来实现 LCD 背光亮度的调节，进入如下目录：</p>
<div class="hljs code-wrapper"><pre><code class="hljs awk"><span class="hljs-regexp">/sys/</span>devices<span class="hljs-regexp">/platform/</span>backlight<span class="hljs-regexp">/backlight/</span>backlight</code></pre></div>

<p>此目录下的文件如图 所示：</p>
<p><img src="/2020/09/13/NOTE/ARM-Linux/%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91%E7%AF%87/16%E3%80%81Linux_LCD%E9%A9%B1%E5%8A%A8%E5%AE%9E%E9%AA%8C/image-20200829181040258.png" srcset="/img/loading.gif" lazyload alt="image-20200829181040258"></p>
<p>图中的 brightness 表示当前亮度等级，max_bgigntness 表示最大亮度等级。当前这两个文件内容如图所示：</p>
<p><img src="/2020/09/13/NOTE/ARM-Linux/%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91%E7%AF%87/16%E3%80%81Linux_LCD%E9%A9%B1%E5%8A%A8%E5%AE%9E%E9%AA%8C/image-20200829181118422.png" srcset="/img/loading.gif" lazyload alt="image-20200829181118422"></p>
<p>从图可以看出，当前屏幕亮度等级为 6，根据前面的分析可以，这个是 50%亮度。屏幕最大亮度等级为 7。如果我们要修改屏幕亮度，只需要向 brightness 写入需要设置的屏幕亮度等级即可。比如设置屏幕亮度等级为 7，那么可以使用如下命令：</p>
<div class="hljs code-wrapper"><pre><code class="hljs apache"><span class="hljs-attribute">echo</span> <span class="hljs-number">7</span> &gt; brightness</code></pre></div>

<p>输入上述命令以后就会发现屏幕亮度增大了，如果设置 brightness 为 0 的话就会关闭 LCD背光，屏幕就会熄灭。</p>
<h3 id="4-LCD-自动关闭解决方法"><a href="#4-LCD-自动关闭解决方法" class="headerlink" title="4| LCD  自动关闭解决方法"></a>4| LCD  自动关闭解决方法</h3><p>默认情况下 10 分钟以后 LCD 就会熄屏，这个并不是代码有问题，而是 Linux 内核设置的，就和我们用手机或者电脑一样，一段时间不操作的话屏幕就会熄灭，以节省电能。解决这个问题有多种方法，我们依次来看一下：</p>
<h4 id="1-按键盘唤醒"><a href="#1-按键盘唤醒" class="headerlink" title="1.按键盘唤醒"></a>1.按键盘唤醒</h4><p>最简单的就是按下回车键唤醒屏幕，我们在前面将 I.MX6U-ALPHA 开发板上的 KEY按键注册为了回车键，因此按下开发板上的 KEY 按键即可唤醒屏幕。如果开发板上没有按键的话可以外接 USB 键盘，然后按下 USB 键盘上的回车键唤醒屏幕。</p>
<h4 id="2-关闭-10-分钟熄屏功能"><a href="#2-关闭-10-分钟熄屏功能" class="headerlink" title="2.关闭 10  分钟熄屏功能"></a>2.关闭 10  分钟熄屏功能</h4><p>在 Linux 源码中找到 drivers&#x2F;tty&#x2F;vt&#x2F;vt.c 这个文件，在此文件中找到 blankinterval 变量，如下所示：</p>
<div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-number">179</span> <span class="hljs-type">static</span> <span class="hljs-type">int</span> vesa_blank_mode;
<span class="hljs-number">180</span> <span class="hljs-type">static</span> <span class="hljs-type">int</span> vesa_off_interval;
<span class="hljs-number">181</span> <span class="hljs-type">static</span> <span class="hljs-type">int</span> blankinterval = <span class="hljs-number">10</span>*<span class="hljs-number">60</span>;</code></pre></div>

<p>blankinterval 变量控制着 LCD 关闭时间，默认是 10*60，也就是 10 分钟。将 blankinterval的值改为 0 即可关闭 10 分钟熄屏的功能，修改完成以后需要重新编译 Linux 内核，得到新的zImage，然后用新的 zImage 启动开发板。</p>
<h4 id="3-编写一个-APP-来关闭熄屏功能"><a href="#3-编写一个-APP-来关闭熄屏功能" class="headerlink" title="3.编写一个 APP  来关闭熄屏功能"></a>3.编写一个 APP  来关闭熄屏功能</h4><p>在 ubuntu 中新建一个名为 lcd_always_on.c 的文件，然后在里面输入如下所示内容：</p>
<div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-number">1</span> <span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span>
<span class="hljs-number">2</span> <span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-number">3</span> <span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span>
<span class="hljs-number">4</span>
<span class="hljs-number">5</span>
<span class="hljs-number">6</span> <span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span>
7 &#123;
<span class="hljs-number">8</span> 		<span class="hljs-type">int</span> fd;
<span class="hljs-number">9</span> 		fd = open(<span class="hljs-string">&quot;/dev/tty1&quot;</span>, O_RDWR);
<span class="hljs-number">10</span> 		write(fd, <span class="hljs-string">&quot;\033[9;0]&quot;</span>, <span class="hljs-number">8</span>);
<span class="hljs-number">11</span> 		close(fd);
<span class="hljs-number">12</span> 		<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
<span class="hljs-number">13</span> &#125;</code></pre></div>

<p>使用如下命令编译 lcd_always_on.c 这个文件：</p>
<div class="hljs code-wrapper"><pre><code class="hljs sh">arm-linux-gnueabihf-gcc lcd_always_on.c -o lcd_always_on</code></pre></div>

<p>编译生成 lcd_always_on 以后将此可执行文件拷贝到开发板根文件系统的&#x2F;usr&#x2F;bin 目录中，然后给予可执行权限。设置 lcd_always_on 这个软件为开机自启动，打开&#x2F;etc&#x2F;init.d&#x2F;rcS，在此文件最后面加入如下内容：</p>
<div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-number">1</span> cd /usr/bin
<span class="hljs-number">2</span> ./lcd_always_on
<span class="hljs-number">3</span> cd ..</code></pre></div>

<p>修改完成以后保存&#x2F;etc&#x2F;init.d&#x2F;rcS 文件，然后重启开发板即可。关于 Linux 下的 LCD 驱动我们就讲到这里。</p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/NOTE/">NOTE</a>
                    
                      <a class="hover-with-bg" href="/categories/NOTE/ARM-Linux/">ARM-Linux</a>
                    
                      <a class="hover-with-bg" href="/categories/NOTE/ARM-Linux/%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91%E7%AF%87/">驱动开发篇</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/Embedded/">Embedded</a>
                    
                      <a class="hover-with-bg" href="/tags/ARM/">ARM</a>
                    
                      <a class="hover-with-bg" href="/tags/Linux/">Linux</a>
                    
                      <a class="hover-with-bg" href="/tags/%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91/">驱动开发</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2020/09/13/NOTE/ARM-Linux/%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91%E7%AF%87/15%E3%80%81Linux_INPUT%E5%AD%90%E7%B3%BB%E7%BB%9F%E5%AE%9E%E9%AA%8C/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">15| Linux INPUT子系统实验</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2020/09/13/NOTE/ARM-Linux/%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91%E7%AF%87/17%E3%80%81Linux_RTC%E9%A9%B1%E5%8A%A8%E5%AE%9E%E9%AA%8C/">
                        <span class="hidden-mobile">17| Linux RTC驱动</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
        typing(title);
      
    })(window, document);
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
